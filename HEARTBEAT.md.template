## ğŸŒŠ Tide Watch - Session Capacity Monitoring

**Check session capacity and warn at configured thresholds.**

### Schedule

**Parse check frequency from AGENTS.md:**

**Look for monitoring schedule section:**
```markdown
**Monitoring schedule:**
- Check frequency: Every 1 hour
```

**Extract frequency:**
- Look for: `- Check frequency: Every N minutes` or `Every N hours`
- Extract number and unit
- Also support: `manual` (disable heartbeat checks)

**Parse format:**
- `Every 15 minutes` â†’ 15 minutes
- `Every 30 minutes` â†’ 30 minutes
- `Every 1 hour` â†’ 60 minutes
- `Every 2 hours` â†’ 120 minutes
- `manual` â†’ Skip heartbeat checks entirely

**Validate:**
- Range: 5 minutes to 6 hours (360 minutes)
- If outside range, fall back to default: 60 minutes (1 hour)
- If `manual`, skip all automatic checks

**Store parsed frequency:**
```
check_frequency_minutes = 60  (or custom value)
heartbeat_enabled = true  (false if 'manual')
```

**If heartbeat disabled (manual):**
- Skip all automatic monitoring
- Return: "Tide Watch heartbeat disabled (frequency set to 'manual')"
- User must explicitly ask for capacity checks

### Monitoring Tasks

1. **Check current session capacity:**
   ```
   Run session_status
   Calculate: percentage = (tokens_used / tokens_max) * 100
   ```

2. **Parse warning thresholds from AGENTS.md:**
   
   **Look for the Tide Watch configuration section:**
   ```markdown
   ## ğŸŒŠ TIDE WATCH: Context Window Monitoring
   
   **Warning thresholds:**
   - **75%**: ğŸŸ¡ ...
   - **85%**: ğŸŸ  ...
   - **90%**: ğŸ”´ ...
   - **95%**: ğŸš¨ ...
   ```
   
   **Extract threshold percentages:**
   - Scan for lines matching pattern: `- **XX%**:` where XX is a number
   - Extract all percentage values in order
   - Example: `[75, 85, 90, 95]`
   
   **Validate extracted thresholds:**
   - Must be ascending order (each threshold > previous)
   - Range: 50-99% (reasonable capacity levels)
   - Minimum 2 thresholds, maximum 6 thresholds
   - All values must be integers
   
   **If validation fails:**
   - Log warning: "Invalid threshold configuration, using defaults"
   - Fall back to defaults: `[75, 85, 90, 95]`
   - Continue with monitoring using defaults
   
   **Store parsed thresholds for this session:**
   ```
   session_thresholds = [75, 85, 90, 95]  (or custom values)
   ```

3. **Compare current capacity against parsed thresholds:**
   - Determine which threshold(s) have been crossed
   - Track which thresholds already warned in this session
   - Only consider thresholds not yet warned about

4. **Issue warnings for new thresholds:**
   
   **Determine warning severity based on position:**
   - First threshold (lowest): ğŸŸ¡ Early warning
   - Middle threshold(s): ğŸŸ  Action recommended  
   - Second-to-last threshold: ğŸ”´ Urgent
   - Last threshold (highest): ğŸš¨ Critical
   
   **Generate appropriate warning message:**
   ```
   For early warning (ğŸŸ¡):
   "Heads up: Context at {threshold}%. Consider wrapping up or switching channels soon."
   
   For action recommended (ğŸŸ ):
   "Context at {threshold}%. Recommend finishing current task and resetting session."
   
   For urgent (ğŸ”´):
   "Context at {threshold}%! Session will lock at 100%. Ready to help you reset?"
   
   For critical (ğŸš¨):
   "CRITICAL: Context at {threshold}%! Save important info to memory NOW and reset."
   ```
   
   **Examples with different threshold configurations:**
   
   Default `[75, 85, 90, 95]`:
   - 75% = ğŸŸ¡ Early warning
   - 85% = ğŸŸ  Action recommended
   - 90% = ğŸ”´ Urgent
   - 95% = ğŸš¨ Critical
   
   Minimalist `[80, 95]`:
   - 80% = ğŸŸ¡ Early warning (first)
   - 95% = ğŸš¨ Critical (last)
   
   Conservative `[60, 70, 80, 90]`:
   - 60% = ğŸŸ¡ Early warning (first)
   - 70% = ğŸŸ  Action recommended (middle)
   - 80% = ğŸŸ  Action recommended (middle)
   - 90% = ğŸš¨ Critical (last)

5. **Suggest actions based on severity:**
   - At urgent thresholds (ğŸ”´): Offer to save context to memory/YYYY-MM-DD.md
   - At urgent thresholds (ğŸ”´): Provide session reset command
   - At critical threshold (ğŸš¨): Be insistent about saving and resetting
   - At critical threshold (ğŸš¨): Automatically offer full reset workflow

6. **Track threshold crossings:**
   - Only warn once per threshold per session
   - Reset tracking when session is reset
   - Store tracking state in memory (ephemeral, per-session)

### Auto-Backup

**âš ï¸ Check if backups are enabled first:**

1. **Parse backup configuration from AGENTS.md:**
   
   **Look for the auto-backup section:**
   ```markdown
   **Auto-backup:**
   - Enabled: true
   - Trigger at thresholds: [90, 95]
   - Retention: 7 days
   - Compress: false
   ```
   
   **Extract configuration values:**
   
   **Enabled:**
   - Look for: `- Enabled: true` or `- Enabled: false`
   - Default: `true` if not found
   
   **Trigger thresholds:**
   - Look for: `- Trigger at thresholds: [XX, YY, ZZ]`
   - Extract array of numbers from brackets
   - Example: `[90, 95]`
   - Default: `[90, 95]` if not found
   
   **Retention:**
   - Look for: `- Retention: N days` where N is a number
   - Extract number of days
   - Range: 1-365 days
   - Default: `7` if not found
   
   **Compress:**
   - Look for: `- Compress: true` or `- Compress: false`
   - Default: `false` if not found
   
   **Validate backup trigger thresholds:**
   - Must be subset of warning thresholds
   - Must be in ascending order
   - Range: 50-99%
   - If validation fails, fall back to `[90, 95]`

2. **If backups are disabled (`Enabled: false`):**
   - Skip this entire Auto-Backup section
   - No backups will be created
   - Proceed to next monitoring task
   - Return: "Auto-backup is disabled (set Enabled: true to enable)"

3. **If backups are enabled (`Enabled: true`), determine if backup should be triggered:**
   - Check current capacity against backup trigger thresholds
   - Track which thresholds have already triggered backups this session
   - Only backup once per threshold per session (don't re-backup at same level)

4. **Execute backup when threshold crossed:**
   
   **Determine session file location:**
   ```bash
   # Get current session key from session context
   # Example: "agent:main:discord:channel:1471358153848389662"
   
   # Map to session file
   # Format: ~/.openclaw/agents/<agent>/sessions/<session-id>.jsonl
   # Example: ~/.openclaw/agents/main/sessions/6eff94ac-dde7-4621-acaf-66bb431db822.jsonl
   ```
   
   **Create backup directory if needed:**
   ```bash
   mkdir -p ~/.openclaw/agents/main/sessions/backups
   ```
   
   **Generate backup filename:**
   ```
   Format: <session-id>-<threshold>-<timestamp>.jsonl[.gz]
   Example: 6eff94ac-90-20260223-170500.jsonl
   Example (compressed): 6eff94ac-95-20260223-171200.jsonl.gz
   
   Timestamp format: YYYYMMDD-HHMMSS (local time)
   Threshold: percentage that triggered backup (75, 85, 90, 95, etc.)
   ```
   
   **Execute backup command:**
   ```bash
   # Without compression:
   cp ~/.openclaw/agents/main/sessions/<session-id>.jsonl \
      ~/.openclaw/agents/main/sessions/backups/<session-id>-<threshold>-<timestamp>.jsonl
   
   # With compression:
   gzip -c ~/.openclaw/agents/main/sessions/<session-id>.jsonl \
      > ~/.openclaw/agents/main/sessions/backups/<session-id>-<threshold>-<timestamp>.jsonl.gz
   ```
   
   **Verify backup integrity:**
   ```bash
   # Check backup file exists and has content
   ls -lh ~/.openclaw/agents/main/sessions/backups/<backup-filename>
   
   # Verify file size > 0
   # If compressed, verify it can be decompressed
   ```
   
   **Log backup completion:**
   ```
   âœ… Session backed up: <backup-filename>
   Trigger: <threshold>% threshold crossed
   Size: <file-size>
   Location: ~/.openclaw/agents/main/sessions/backups/
   ```
   
   **Mark threshold as backed up:**
   ```
   Track internally: threshold <X>% backup completed for this session
   Don't re-backup at this threshold unless session is reset
   ```

5. **Cleanup old backups (if retention configured):**
   ```bash
   # Find backups older than retention days
   find ~/.openclaw/agents/main/sessions/backups/ \
     -name "*.jsonl*" \
     -type f \
     -mtime +<retention-days> \
     -delete
   
   # Log cleanup
   Removed N old backup(s) (retention: <retention-days> days)
   ```

### Loading Session Backups

**When user requests loading a session from backup:**

1. **List available backups:**
   ```bash
   ls -lht ~/.openclaw/agents/main/sessions/backups/<session-id>-*.jsonl*
   ```

2. **Show backups with details:**
   ```
   Available backups for session <session-id>:
   
   1. 90% threshold - 2026-02-23 17:05 (1.6 MB)
   2. 95% threshold - 2026-02-23 17:12 (1.7 MB)
   
   Which backup would you like to restore?
   ```

3. **Load selected backup:**
   ```bash
   # If compressed, decompress first
   gunzip -c ~/.openclaw/agents/main/sessions/backups/<backup-file>.gz \
     > /tmp/restored-session.jsonl
   
   # Copy to session location
   cp ~/.openclaw/agents/main/sessions/backups/<backup-file> \
      ~/.openclaw/agents/main/sessions/<session-id>.jsonl
   ```

4. **Verify loaded backup:**
   ```
   âœ… Session loaded from backup
   Backup: <backup-filename>
   Loaded to: <session-file>
   
   Note: Restart OpenClaw gateway or reconnect to load the session.
   ```

### Behavior Notes

**Silent operation:**
- Only speak up when threshold crossed
- No output if capacity is below all thresholds
- Return HEARTBEAT_OK when nothing needs attention

**Warning discipline:**
- One warning per threshold per session
- Don't repeat warnings if capacity stays at same level
- Reset warning state if capacity drops below threshold (user cleared context)

**Critical threshold (95%+):**
- Automatically offer to save context to memory
- Provide full session reset workflow
- Be more insistent than lower thresholds

### Configuration

Users configure monitoring in `AGENTS.md`:

```markdown
## ğŸŒŠ TIDE WATCH: Context Window Monitoring

**Monitoring schedule:**
- Check frequency: Every 1 hour

**Warning thresholds:**
- **75%**: ğŸŸ¡ Early warning
- **85%**: ğŸŸ  Action recommended
- **90%**: ğŸ”´ Urgent
- **95%**: ğŸš¨ Critical

**Auto-backup:** (future)
- Enabled: false
- Trigger at thresholds: [90, 95]
```

---

**Skill:** [Tide Watch](https://github.com/chrisagiddings/openclaw-tide-watch) ğŸŒŠ
